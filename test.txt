import os
import subprocess

BINARY_PATH = "/app/github-mcp-server"

GITHUB_TOKEN = os.environ.get("GITHUB_PERSONAL_ACCESS_TOKEN", "")
EXTRA_ARGS = ["--read-only"]

# Start the MCP binary as a persistent subprocess
env = os.environ.copy()
env["GITHUB_PERSONAL_ACCESS_TOKEN"] = GITHUB_TOKEN

proc = subprocess.Popen(
    [BINARY_PATH] + EXTRA_ARGS,
    env=env,
    stdin=subprocess.PIPE,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    text=True,      # line-based stdin/stdout text mode
    bufsize=1       # line-buffered for immediate read
)



from fastapi import APIRouter, Request, Response
from services.github_mcp_service import proc  # <-- your running MCP binary
import json

router = APIRouter()

@router.post("/github-mcp")
async def github_mcp_route(request: Request):
    """
    JSON-RPC passthrough proxy for GitHub MCP server.
    Accepts:
        {
            "id": 1,
            "method": "github.repo.contents",
            "params": { ... }
        }
    """
    try:
        rpc_req = await request.json()

        # Validate
        if "method" not in rpc_req:
            return {"error": "Missing required field 'method' (JSON-RPC)"}

        # Default fields for JSON-RPC protocol
        rpc_req.setdefault("jsonrpc", "2.0")
        rpc_req.setdefault("id", 1)
        rpc_req.setdefault("params", {})

        # Convert request to JSON for MCP stdin
        message = json.dumps(rpc_req) + "\n"

        # Write JSON-RPC request to MCP server via stdin
        try:
            proc.stdin.write(message)
            proc.stdin.flush()
        except BrokenPipeError:
            return {"error": "Broken pipe â€” MCP binary closed. Ensure you're sending valid JSON-RPC."}

        # Read JSON-RPC response (1 per line)
        response_line = proc.stdout.readline().strip()

        # Try parsing JSON-RPC result
        try:
            response_json = json.loads(response_line)
            return response_json
        except Exception:
            # If response is not valid JSON
            return {"raw": response_line}

    except Exception as e:
        return {"error": str(e)}
